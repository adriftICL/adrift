%%inherit(file="layout.haml")

#control_panel
  #controls


:javascript
  var global_count = 0;
  function notification(message, css_class) {
    var local_count = ++global_count;
    $elm = $("#notification");
    $elm.slideUp(400, function(){
      $elm.attr('class','').addClass(css_class);
      $elm.text(message);
      $elm.slideDown(400, function(){
        setTimeout(function(){
          if (local_count == global_count) {
            $elm.slideUp();
          }
        }, 5000);
      });
    });
  }
  $(document).ready(function(){
    // $("#map_canvas").css("width", "1024px");
    var width = $("#map_canvas").width();
    $("#map_canvas").css("height", width / 2 + "px");

    var mapOptions = {
      zoom: 2,
      maxZoom: 2,
      draggable: true,
      zoomControl: false,
      scrollwheel: false,
      disableDoubleClickZoom: true,
      disableDefaultUI: true,
      center: new google.maps.LatLng(8, 130.644), // Sydney
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      styles: [
          {
            "featureType": "administrative",
            "stylers": [
              { "visibility": "off" }
            ]
          },{
            "featureType": "landscape",
            "stylers": [
              { "color": "#ffffff" } 
            ]
          },{
            "featureType": "water",
            "stylers": [
              { "color": "#309CC0" }
            ]
          }
        ]
    };
    var map = new google.maps.Map(document.getElementById('map_canvas'),
        mapOptions);

    $(document).ajaxStart(function(){
      $.blockUI({ message: '<div class="loading"><img src="/static/busy.gif" /> Loading tracer map...</div>' });
    });
    $(document).ajaxStop($.unblockUI);

    var heatMapData = [];
    var heatmap = new google.maps.visualization.HeatmapLayer({
      data: heatMapData,
      radius: 1
    });
    var marker = new google.maps.Marker({map:map});
    google.maps.event.addListener(map, 'click', function(mouseEvent) {
      marker.setPosition(mouseEvent.latLng);
      $.getJSON("/run/" + mouseEvent.latLng, function(data) {
        heatmap.setMap(null);
        heatMapData = data[data.length-1];
        if (heatMapData.length == 0) {
          notification("You clicked on land.", "error");
        } else {
          notification("This is where the tracer could be after 10 years."); // , "success");
        }
        for(var i = 0; i < heatMapData.length; i++) {
          var x = heatMapData[i].location;
          heatMapData[i].location = new google.maps.LatLng(x.lat, x.lng);
          heatMapData[i].weight *= 10000;
        }
        heatmap = new google.maps.visualization.HeatmapLayer({
            data: heatMapData,
            radius: 10,
            maxIntensity : 1e-2 * 10000,
        });
        heatmap.setMap(map);
      });
    });

    google.maps.event.addListener(map, 'center_changed', function() {
      var newCenter = map.getCenter();
      if (Math.abs(newCenter.lat()-8) > 1e-4) {
        map.panTo(new google.maps.LatLng(8, newCenter.lng()));
      }
    });
  });

#map_notification_container
  #notification
    Welcome, click on a point on the map
  #map_canvas
